
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>VITAC – Visualizador (FINAL)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --cols: 7; --rows: 30; }
    * { box-sizing: border-box; }
    html, body { margin: 0; height: 100%; font-family: Arial, sans-serif; }
    #grid { display: grid; grid-template-columns: repeat(7, 1fr); grid-template-rows: repeat(30, 1fr);
            height: 100vh; gap: 4px; padding: 4px; background: #fafafa; }
    .cell { border: 1px solid #e0e0e0; background: #fff; border-radius: 4px; }

    #logo { grid-column: 1 / 2; grid-row: 1 / 5; background: #004f9e; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    #logo img { max-width: 100%; max-height: 100%; object-fit: contain; }

    #selector { grid-column: 1 / 2; grid-row: 5 / 31; background: #f7f7f7; padding: 6px; overflow-y: auto;
                display: grid; grid-template-columns: 1fr; gap: 6px; align-content: start; grid-auto-rows: min-content; }
    #selector button {
      width: 100%; padding: 6px 8px; border: 1px solid #ccc; background: #fff; cursor: pointer;
      border-radius: 6px; transition: background 0.15s; font-size: 13px; line-height: 1.2; height: 32px;
      display: flex; align-items: center; justify-content: center;
    }
    #selector button:hover { background: #eef1ff; }
    #selector button.active { background: #004f9e; color: #fff; }

    #chartMcolaCont { grid-column: 2 / 4; grid-row: 1 / 14; padding: 8px; display: flex; }
    #chartMsurCont  { grid-column: 2 / 4; grid-row: 16 / 29; padding: 8px; display: flex; }
    #infoPanel { grid-column: 2 / 4; grid-row: 14 / 16; padding: 4px 6px; display: flex; gap: 6px; align-items: center; }
    #infoPanelMsur { grid-column: 2 / 4; grid-row: 29 / 31; padding: 4px 6px; display: flex; gap: 6px; align-items: center; }
    .infoBox { display: flex; gap: 6px; align-items: baseline; background: #f9f9f9; border: 1px solid #ddd; border-radius: 3px; padding: 2px 4px; }
    .infoBox .label { font-weight: 700; }
    .infoBox .value { font-weight: 600; }

    #donutCaptCont { grid-column: 4 / 6; grid-row: 1 / 23; padding: 8px; display: flex; }
    #donutCapt { width: 100%; height: 100%; }
    #panelLance { grid-column: 4 / 6; grid-row: 23 / 31; padding: 8px; display: flex; flex-direction: column; gap: 6px; font-size: 0.9rem; }
    .legend { display: flex; justify-content: center; gap: 12px; font-weight: 600; }
    .legend .sq { width: 10px; height: 10px; display: inline-block; margin-right: 4px; }
    .sq.mcola { background: #f28e2b; } .sq.msur  { background: #4e79a7; } .sq.otros { background: #76b7b2; }
    .kgs { display: flex; justify-content: center; gap: 24px; }
    .kgBox { border: 1px solid #222; padding: 6px 16px; font-weight: 700; }

    .meta { width: 100%; border-collapse: collapse; }
    .meta th, .meta td { border: 1px solid #000; padding: 4px; text-align: center; }
    .meta th { background: #f0f0f0; }

    #mapLance { grid-column: 6 / 8; grid-row: 1 / 31; }
    .leaflet-tooltip.lance-label { background: #fff; border: 1px solid #999; border-radius: 3px; padding: 2px 4px; font-size: 11px; font-weight: bold; color: #333; }

    #overlay { position: fixed; inset: 0; background: #fff; display:none; align-items:center; justify-content:center; }
    #overlay .box { max-width: 640px; border:1px solid #ddd; padding:16px; border-radius:8px; background:#fafafa; font-family: ui-sans-serif, system-ui, Arial; }
    #overlay h2 { margin:0 0 8px; font-size:18px; }
    #overlay code { display:block; white-space:pre-wrap; background:#fff; border:1px solid #eee; padding:8px; border-radius:6px; }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="grid">
    <div id="logo" class="cell"><img id="logo-img" alt="Logo VITAC" /></div>
    <div id="selector" class="cell"></div>
    <div id="chartMcolaCont" class="cell"><canvas id="chartMcola"></canvas></div>
    <div id="infoPanel" class="cell">
      <div class="infoBox"><span class="label">MODA</span><span id="valModa" class="value">–</span></div>
      <div class="infoBox"><span class="label">FREC</span><span id="valFrec" class="value">–</span></div>
      <div class="infoBox"><span class="label">RANGO</span><span id="valRango" class="value">–</span></div>
      <div class="infoBox"><span class="label">TOTAL</span><span id="valTotal" class="value">–</span></div>
    </div>
    <div id="chartMsurCont" class="cell"><canvas id="chartMsur"></canvas></div>
    <div id="infoPanelMsur" class="cell">
      <div class="infoBox"><span class="label">MODA</span><span id="valModaS" class="value">–</span></div>
      <div class="infoBox"><span class="label">FREC</span><span id="valFrecS" class="value">–</span></div>
      <div class="infoBox"><span class="label">RANGO</span><span id="valRangoS" class="value">–</span></div>
      <div class="infoBox"><span class="label">TOTAL</span><span id="valTotalS" class="value">–</span></div>
    </div>
    <div id="donutCaptCont" class="cell"><canvas id="donutCapt"></canvas></div>
    <div id="panelLance" class="cell">
      <div class="legend">
        <span><span class="sq mcola" style="background:#f28e2b;width:10px;height:10px;display:inline-block;margin-right:4px;"></span> Merluza cola</span>
        <span><span class="sq msur"  style="background:#4e79a7;width:10px;height:10px;display:inline-block;margin-right:4px;"></span> Merluza sur</span>
        <span><span class="sq otros" style="background:#76b7b2;width:10px;height:10px;display:inline-block;margin-right:4px;"></span> Otros</span>
      </div>
      <div class="kgs">
        <div class="kgBox"><span id="kgMcola">–</span> kg</div>
        <div class="kgBox"><span id="kgMsur">–</span> kg</div>
        <div class="kgBox"><span id="kgOtros">–</span> kg</div>
      </div>
      <table class="meta">
        <thead><tr><th>FECHA</th><th>LATITUD</th><th>LONGITUD</th></tr></thead>
        <tbody><tr><td id="metaFecha"></td><td id="metaLat"></td><td id="metaLon"></td></tr></tbody>
      </table>
    </div>
    <div id="mapLance" class="cell"></div>
  </div>

  <div id="overlay"><div class="box">
    <h2>No se pudieron cargar los datos</h2>
    <p>Revisa que <strong>data.json</strong> esté en la raíz y sea válido.</p>
    <code id="ov-msg"></code>
  </div></div>

  <script>
    const DATA_URL = 'data.json?v=' + Date.now();
    const FIXED_CLASSES = Array.from({length:22}, (_,i)=>{ const lo=15+i*5, hi=lo+4; return `${lo}-${hi}`; });
    const LOGO_CANDIDATES = ['logo_vitac.png','logo vitac.png','logo_vitac.jpg','logo_vitac.jpeg','logo_vitac.PNG','logo_vitac.svg'];

    function setLogo(){
      const img = document.getElementById('logo-img');
      let i = 0;
      img.onerror = () => { i++; if(i < LOGO_CANDIDATES.length) img.src = LOGO_CANDIDATES[i]; };
      img.src = LOGO_CANDIDATES[0];
    }
    function showError(msg){
      const ov = document.getElementById('overlay');
      document.getElementById('ov-msg').textContent = String(msg || '');
      ov.style.display = 'flex';
    }
    function normalize(arr){
      const out = new Array(FIXED_CLASSES.length).fill(0);
      if(Array.isArray(arr)){
        for(let i=0;i<Math.min(arr.length,out.length);i++) out[i] = Number(arr[i]||0);
      }
      return out;
    }
    function statsFromFreq(arr){
      const total = arr.reduce((a,b)=>a+b,0);
      let max = 0, maxIdx = -1;
      for(let i=0;i<arr.length;i++){ if(arr[i]>max){max=arr[i]; maxIdx=i;} }
      const first = arr.findIndex(v=>v>0);
      const last = arr.length-1-[...arr].reverse().findIndex(v=>v>0);
      const rango = (first===-1) ? '–' : `${FIXED_CLASSES[first]} / ${FIXED_CLASSES[last]}`;
      return { total, max, moda: FIXED_CLASSES[maxIdx]||'–', rango };
    }
    function toDMS(lat, lon){
      function conv(v, isLat){
        if(v==null || isNaN(v)) return '';
        const hem = v < 0 ? (isLat ? 'S':'W') : (isLat ? 'N':'E');
        const abs = Math.abs(v);
        const deg = Math.floor(abs);
        const mins = ((abs - deg) * 60);
        const minsTxt = mins.toFixed(1);
        return `${deg}\u00B0${minsTxt}'${hem}`;
      }
      return { lat: conv(lat, true), lon: conv(lon, false) };
    }

    let DATA=null, current=null;
    let chartMcola=null, chartMsur=null, chartDonut=null;
    let mapL=null, marker=null;

    async function loadData(){
      const res = await fetch(DATA_URL, { cache: 'no-store' });
      if(!res.ok) throw new Error('No se pudo cargar '+DATA_URL+' ('+res.status+')');
      const json = await res.json();
      if(!json || !Array.isArray(json.lances) || json.lances.length===0){
        throw new Error('El archivo tiene formato válido pero no trae "lances".');
      }
      if(!json.freq || !json.freq.Mcola || !json.freq.Msur){
        throw new Error('Faltan bloques "freq.Mcola" o "freq.Msur".');
      }
      DATA = json;
    }

    function buildSelector(){
      const cont = document.getElementById('selector'); cont.innerHTML='';
      DATA.lances.forEach(n=>{
        const b=document.createElement('button'); b.textContent='Lance '+n; b.dataset.lance=n;
        b.onclick=()=>setCurrent(n); cont.appendChild(b);
      });
      setCurrent(DATA.lances[0]);
    }

    function setCurrent(n){
      current = Number(n);
      document.querySelectorAll('#selector button').forEach(b=>b.classList.toggle('active', Number(b.dataset.lance)===current));
      updateAll();
    }

    function drawLinesMcola(){
      const ctx=document.getElementById('chartMcola').getContext('2d');
      const data=normalize(DATA.freq.Mcola[current]||[]);
      const ds=[{label:'Lance '+current,data, borderColor:'#f28e2b', pointBackgroundColor:'#f28e2b', fill:false, tension:0.3, borderWidth:2, pointRadius:3}];
      if(chartMcola){ chartMcola.data.labels=FIXED_CLASSES; chartMcola.data.datasets=ds; chartMcola.options.plugins.title.text='Merluza de Cola – Lance '+current; chartMcola.update(); }
      else { chartMcola=new Chart(ctx,{type:'line',data:{labels:FIXED_CLASSES,datasets:ds},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'},title:{display:true,text:'Merluza de Cola'}},scales:{y:{beginAtZero:true,title:{display:true,text:'Frecuencia'}},x:{title:{display:true,text:'Clase de Talla (cm)'}}}}); }
      const s=statsFromFreq(data);
      document.getElementById('valModa').textContent=s.moda;
      document.getElementById('valFrec').textContent=s.max;
      document.getElementById('valRango').textContent=s.rango;
      document.getElementById('valTotal').textContent=s.total;
    }

    function drawLinesMsur(){
      const ctx=document.getElementById('chartMsur').getContext('2d');
      const data=normalize(DATA.freq.Msur[current]||[]);
      const ds=[{label:'Lance '+current,data, borderColor:'#4e79a7', pointBackgroundColor:'#4e79a7', fill:false, tension:0.3, borderWidth:2, pointRadius:3}];
      if(chartMsur){ chartMsur.data.labels=FIXED_CLASSES; chartMsur.data.datasets=ds; chartMsur.options.plugins.title.text='Merluza del Sur – Lance '+current; chartMsur.update(); }
      else { chartMsur=new Chart(ctx,{type:'line',data:{labels:FIXED_CLASSES,datasets:ds},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'},title:{display:true,text:'Merluza del Sur'}},scales:{y:{beginAtZero:true,title:{display:true,text:'Frecuencia'}},x:{title:{display:true,text:'Clase de Talla (cm)'}}}}); }
      const s=statsFromFreq(data);
      document.getElementById('valModaS').textContent=s.moda;
      document.getElementById('valFrecS').textContent=s.max;
      document.getElementById('valRangoS').textContent=s.rango;
      document.getElementById('valTotalS').textContent=s.total;
    }

    function drawDonut(){
      const ctx=document.getElementById('donutCapt').getContext('2d');
      const vals=DATA.donut[current]||[0,0,0];
      if(chartDonut){ chartDonut.data.datasets[0].data=vals; chartDonut.options.plugins.title.text='Capturas – Lance '+current; chartDonut.update(); }
      else { chartDonut=new Chart(ctx,{type:'doughnut',data:{labels:['Merluza Sur','Merluza Cola','Otros'],datasets:[{data:vals,backgroundColor:['#4e79a7','#f28e2b','#76b7b2'],borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'},title:{display:true,text:'Capturas'}}}}); }
      const info=DATA.info[current]||{};
      const pt=DATA.coords[current];
      if(pt && pt.length===2){
        const d=toDMS(pt[0], pt[1]);
        document.getElementById('metaLat').textContent = d.lat;
        document.getElementById('metaLon').textContent = d.lon;
      } else {
        document.getElementById('metaLat').textContent = info.Lat || '';
        document.getElementById('metaLon').textContent = info.Lon || '';
      }
      document.getElementById('metaFecha').textContent=info.Fecha||'';
      document.getElementById('kgMcola').textContent=((info.Mcola||0)).toFixed(1);
      document.getElementById('kgMsur').textContent=((info.Msur||0)).toFixed(1);
      document.getElementById('kgOtros').textContent=((info.Otros||0)).toFixed(1);
    }

    function initMap(){
      mapL=L.map('mapLance').setView([-43,-75],6);
      const bathy=L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}',{maxZoom:13,attribution:'© Esri, GEBCO, NOAA'}).addTo(mapL);
      const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'© OpenStreetMap'});
      L.control.layers({'Bathymetry (Esri)':bathy,'OSM estándar':osm},null,{position:'topright'}).addTo(mapL);
      L.control.scale({ position:'bottomleft', metric:true, imperial:true }).addTo(mapL);
      marker=L.marker([-43,-75]).addTo(mapL);
    }
    function updateMap(){
      if(!mapL) initMap();
      const pt=DATA.coords[current];
      if(pt&&pt.length===2){
        marker.setLatLng(pt);
        mapL.setView(pt,7);
        marker.bindTooltip('Lance '+current,{permanent:true,direction:'top',offset:[0,-10],className:'lance-label'});
      }
    }

    function updateAll(){ drawLinesMcola(); drawLinesMsur(); drawDonut(); updateMap(); }

    (async function(){
      try {
        setLogo();
        await loadData();
        buildSelector();
      } catch(err){
        console.error(err);
        showError(err.message);
      }
    })();
  </script>
</body>
</html>
